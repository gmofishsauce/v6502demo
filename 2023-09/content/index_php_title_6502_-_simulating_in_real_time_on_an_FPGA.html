<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en">
<head>
<title>6502 - simulating in real time on an FPGA - VisualChips</title>
</head>
<body>
		<!-- start content -->
<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Introduction"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Simulating_in_software"><span class="tocnumber">2</span> <span class="toctext">Simulating in software</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Simulating_in_hardware"><span class="tocnumber">3</span> <span class="toctext">Simulating in hardware</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#Passing_a_test_suite"><span class="tocnumber">4</span> <span class="toctext">Passing a test suite</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="#Further_work"><span class="tocnumber">5</span> <span class="toctext">Further work</span></a></li>
<li class="toclevel-1 tocsection-6"><a href="#Resources"><span class="tocnumber">6</span> <span class="toctext">Resources</span></a></li>
</ul>
</td></tr></table><script>if (window.showTocToggle) { var tocShowText = "show"; var tocHideText = "hide"; showTocToggle(); } </script>
<h3> <span class="mw-headline" id="Introduction"> Introduction </span></h3>
<p>In September 2010 the visual6502 project released the <a href="https://web.archive.org/web/20210405071450/http://www.visual6502.org/JSSim/expert.html?steps=10" class="external text" rel="nofollow">JavaScript simulator</a>, which ran a chip animation at about one clock cycle per second - a million times slower than the original 6502 - in a web browser.
</p><p>In fact the transistor level model had already run faster than that, at about 55Hz, as a python implementation (as yet unreleased.) One major difference there is that the graphics animation was done with OpenGL, much faster than JavaScript's Canvas.
</p><p>But to run a test suite, or any demo program or normal game or application, it's desirable to run much faster. It's even more desirable to run at real time, especially if it's possible to interact with original hardware.
</p>
<h3> <span class="mw-headline" id="Simulating_in_software"> Simulating in software </span></h3>
<p>The original bring-up (see <a href="https://web.archive.org/web/20210405071450/http://visual6502.org/downloads.html" class="external text" rel="nofollow">presentation</a>) was in a simulated Atari context, and the accuracy of the simulated video output was a useful clue to the correctness of the simulation. But it was not real time.
</p><p>By January 2011 the browser wars had produced faster browsers, we had significantly improved our code, and we'd also released an expert mode which didn't update a chip animation. The result was an in-browser simulation which could run at 250Hz or better.
</p><p>But in the meantime, only a week or so after the release of the browser version, <a href="https://web.archive.org/web/20210405071450/http://www.pagetable.com/?p=517" class="external text" rel="nofollow">Michael Steil</a> and some collaborators had ported the code to C and were able to run at about 1kHz - they could run up the "COMMODORE 64 BASIC V2" banner within about 10 seconds (but skipping the memory test.)
</p><p>This was only a thousand times slower than the original, running on a computer that was perhaps two million times faster.
</p><p>All of the simulators mentioned so far - in python, JavaScript, and C - are switch-level. They model each pull-down transistor in the circuit and each pass transistor, with some special handling for pullups. The circuit is re-evaluated after each input signal change until it stabilises, which takes several iterations because transistors act bidirectionally. Each signal in the circuit is modelled as high, low or floating.  It's possible that this simple model will need to be revised as we tackle chips with more subtle circuits, but it seems good enough for 6502.
</p>
<h3> <span class="mw-headline" id="Simulating_in_hardware"> Simulating in hardware </span></h3>
<p>From November 2010, Mike J had started a project to convert the transistor-level netlist into a higher-level RTL description, which is presently working in simulation but is not yet published.
</p><p>From mid-December, Peter Monta has been working on a <a href="https://web.archive.org/web/20210405071450/https://github.com/pmonta/FPGA-netlist-tools" class="external text" rel="nofollow">project</a> to convert the transistor-level netlist into a synthesisable form which can be placed on an FPGA and run in-circuit.  Most of the chip is converted to logic gates and storage elements, and the remainder is simulated with a 6-bit model of node voltages and edge currents (using approximately 48 levels during simulation.) So the FPGA is clocked at 50MHz or thereabouts, and manages to simulate a 6502 or 6507 at 1MHz or just above.
</p><p>Note that this verilog design will run at about 4kHz when simulated with the open-source verilator simulator - which is therefore the fastest model available to date.
</p><p>In January 2010 user Xor on the 6502.org forum <a href="https://web.archive.org/web/20210405071450/http://forum.6502.org/viewtopic.php?t=1747" class="external text" rel="nofollow">finalised</a> a verilog model of 6502 which was informed by the transistor netlist found in visual6502, but written by hand as a high level document of the function. On the 18th he published a <a href="https://web.archive.org/web/20210405071450/http://youtu.be/b7O7QJsaHHk" class="external text" rel="nofollow">video</a> of a starfield demo, running at 1MHz. Some code is published on the forum but there's no public release yet.
</p><p>By late January 2010 Peter had his model running Space Invaders, on an OHO FPGA module replacing the 6507 in an original Atari 2600 console.
</p><p><a href="/web/20210405071450/http://visual6502.org/wiki/index.php?title=File:6507-demo0.jpg" class="image"><img alt="6507-demo0.jpg" src="/web/20210405071450im_/http://visual6502.org/wiki/images/thumb/f/f6/6507-demo0.jpg/640px-6507-demo0.jpg" width="640" height="478"/></a>
</p><p><a href="/web/20210405071450/http://visual6502.org/wiki/index.php?title=File:6507-demo1.jpg" class="image"><img alt="6507-demo1.jpg" src="/web/20210405071450im_/http://visual6502.org/wiki/images/thumb/c/c9/6507-demo1.jpg/640px-6507-demo1.jpg" width="640" height="478"/></a>
</p>
<h3> <span class="mw-headline" id="Passing_a_test_suite"> Passing a test suite </span></h3>
<p>Since then, Peter has made further improvements, and Ingo Korb has <a href="https://web.archive.org/web/20210405071450/https://github.com/ikorb/FPGA-netlist-tools" class="external text" rel="nofollow">joined in</a>, and run <a href="https://web.archive.org/web/20210405071450/http://visual6502.org/wiki/index.php?title=6502TestPrograms" class="external text" rel="nofollow">Wolfgang Lorenz' testsuite</a> in a 1541 disk drive, passing all legal opcodes and failing on 16 unsupported opcodes.  (It is expected that a simulated digital model will not behave precisely as a physical CPU when it comes to these deservedly unsupported opcodes - they cause <a href="https://web.archive.org/web/20210405071450/http://visual6502.org/wiki/index.php?title=6502_Opcode_8B_(XAA,_ANE)" class="external text" rel="nofollow">essentially analogue behaviour</a>. It's also true that the FPGA module does not behave, electrically, precisely like an NMOS part.)
</p><p>Ingo has also had success running on FPGA in real time as a CPU replacement in other systems: an Apple IIe clone, VIC20, C64. Ingo has implemented a manual tuning system for the clock delay. (The Apple II Europlus was an unsuccessful experiment - it is thought that the clock skew compensation cannot deal with the slow RAM access times.)
</p><p><a href="/web/20210405071450/http://visual6502.org/wiki/index.php?title=File:6502-fpga-apple2-img_0040.jpg" class="image"><img alt="6502-fpga-apple2-img 0040.jpg" src="/web/20210405071450im_/http://visual6502.org/wiki/images/thumb/6/6e/6502-fpga-apple2-img_0040.jpg/640px-6502-fpga-apple2-img_0040.jpg" width="640" height="480"/></a>
</p><p><a href="/web/20210405071450/http://visual6502.org/wiki/index.php?title=File:6502-fpga-vic20-img_0039.jpg" class="image"><img alt="6502-fpga-vic20-img 0039.jpg" src="/web/20210405071450im_/http://visual6502.org/wiki/images/thumb/7/70/6502-fpga-vic20-img_0039.jpg/640px-6502-fpga-vic20-img_0039.jpg" width="640" height="853"/></a>
</p><p>More pictures, showing functioning vintage software (click through for full size):
</p><p><a href="/web/20210405071450/http://visual6502.org/wiki/index.php?title=File:6502-fpga-apple2-overview-IMG_1086.jpg" class="image"><img alt="6502-fpga-apple2-overview-IMG 1086.jpg" src="/web/20210405071450im_/http://visual6502.org/wiki/images/thumb/b/b2/6502-fpga-apple2-overview-IMG_1086.jpg/240px-6502-fpga-apple2-overview-IMG_1086.jpg" width="240" height="160"/></a>
<a href="/web/20210405071450/http://visual6502.org/wiki/index.php?title=File:6502-fpga-vic20-overview-IMG_1081.jpg" class="image"><img alt="6502-fpga-vic20-overview-IMG 1081.jpg" src="/web/20210405071450im_/http://visual6502.org/wiki/images/thumb/c/c3/6502-fpga-vic20-overview-IMG_1081.jpg/240px-6502-fpga-vic20-overview-IMG_1081.jpg" width="240" height="160"/></a>
<a href="/web/20210405071450/http://visual6502.org/wiki/index.php?title=File:6502-fpga-c64-overview-IMG_1080.jpg" class="image"><img alt="6502-fpga-c64-overview-IMG 1080.jpg" src="/web/20210405071450im_/http://visual6502.org/wiki/images/thumb/3/37/6502-fpga-c64-overview-IMG_1080.jpg/240px-6502-fpga-c64-overview-IMG_1080.jpg" width="240" height="160"/></a>
</p>
<h3> <span class="mw-headline" id="Further_work"> Further work </span></h3>
<p>Work continues on stability and on the maximum speed of the FPGA model. For this to work at all, the model running on the FPGA has to mimic the delays, especially of the clock signals, as well as the CPU logical behaviour.  The FPGA module has to be electrically compatible with the motherboard, including delays, voltage levels and possibly in some cases edge rates.
</p>
<h3> <span class="mw-headline" id="Resources"> Resources </span></h3>
<ul><li> <a href="https://web.archive.org/web/20210405071450/http://www.veripool.org/wiki/verilator" class="external text" rel="nofollow">verilator</a>, a fast open-source verilog simulator
</li><li> <a href="https://web.archive.org/web/20210405071450/http://forum.6502.org/viewtopic.php?t=1747" class="external text" rel="nofollow">Xor's thread</a> on 6502.org forum
</li><li> <a href="https://web.archive.org/web/20210405071450/https://github.com/pmonta/FPGA-netlist-tools" class="external text" rel="nofollow">original FPGA-netlist-tools project</a> on github
</li><li> <a href="https://web.archive.org/web/20210405071450/https://github.com/ikorb/FPGA-netlist-tools" class="external text" rel="nofollow">Ingo's fork</a> of FPGA-netlist-tools project, for apple2, C64, VIC20
</li><li> <a href="https://web.archive.org/web/20210405071450/http://www.google.co.uk/search?q=GODIL40_XC3S250E" class="external text" rel="nofollow">OHO FPGA modules</a>
</li><li> <a href="https://web.archive.org/web/20210405071450/http://enterpoint.co.uk/shop/en/48-craignell1.html" class="external text" rel="nofollow">Enterpoint's FPGA modules</a>
</li></ul>

<!-- 
NewPP limit report
Preprocessor node count: 22/1000000
Post-expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key wiki6502:pcache:idhash:146-0!1!0!!en!2!edit=0 and timestamp 20210404181000 -->
<div class="printfooter">
Retrieved from "<a href="https://web.archive.org/web/20210405071450/http://visual6502.org/wiki/index.php?title=6502_-_simulating_in_real_time_on_an_FPGA">http://visual6502.org/wiki/index.php?title=6502_-_simulating_in_real_time_on_an_FPGA</a>"</div>
		<div id="catlinks" class="catlinks catlinks-allhidden"></div>		<!-- end content -->
</body>
</html>
<!-- written by getter Thu Sep  7 14:35:20 PDT 2023 -->
